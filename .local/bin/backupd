#!/usr/bin/env fish

# Backup directories regularly
# Dependencies: borg

set roots "$HOME"
set excludes "re:^$(string sub --start 2 $HOME)/(\.cache|.local/share|.local/lib|Extern)"
set delay (math "60 * 30")
set repo "$HOME/Extern/Backups"

if not test -e $repo
	mkdir -p $repo
	if not borg init --encryption none
		notify-send -i "backup" -u "critical" -t 0 "Backup repository missing!" "Failed to create $repo"
		return 1
	end
	notify-send -i "backup" "Backup repository missing!" "Created $repo"
end

while true
	borg create $repo::"{hostname}-{user}-{now}" $roots --exclude-caches --exclude "$excludes"
	test $status -eq 2
	and notify-send -i "backup" -u "critical" -t 0 "Failed to create backup!" "Please check backupd"
	borg prune $repo --keep-within 1d --keep-daily 7 --keep-weekly 4 --keep-monthly 1 --keep-yearly 1
	borg compact $repo
	# TODO: remote backup with rsync
	sleep $delay
end
