#!/bin/sh

[ "$1" = "fade" ] && {
	light -O || exit 1
	sleep infinity &
	trap "light -I; kill $!" EXIT
	trap "light -I; exit 0" INT TERM
	for i in $(seq 200); do
		light -T 0.975
		sleep 0.025
	done
	light -S 0
	wait
}

choice="$1"
[ -z "$choice" ] && {
	caffeinate="$(pidof -q swayidle && echo "caffeinate" || echo "uncaffeinate")"
	choices="lock suspend $caffeinate reload logout reboot shutdown"
	choice="$(CH_LINES=9 CH_WIDTH=100 CH_PROMPT="Power Control" choose $choices)"
}

case "$choice" in
	"lock") loginctl lock-session;;
	"suspend") systemctl suspend;;
	"reload") swaymsg reload;;
	"logout") swaymsg exit;;
	"reboot") systemctl reboot;;
	"shutdown") systemctl poweroff;;
	"caffeinate") pkill swayidle;;
	"uncaffeinate") pidof swayidle || swayidle -w \
		idlehint 300 lock "swaylock --daemonize" unlock "pkill -USR1 swaylock" \
		timeout 300 "powerctl fade &"              resume "pkill powerctlfade" \
		timeout 310 "loginctl lock-session"        resume "pkill powerctlfade" \
		timeout 900 "systemctl suspend"            resume "pkill powerctlfade" \
		before-sleep "loginctl lock-session" after-resume "pkill powerctlfade" &;;
	*) return 1;;
esac
