#!/bin/sh

# sh -c "$(curl https://h8c.de/dots)" -- init gui sys

# Where to find dots repo
dots="$HOME/.local/dots"
git_ssh="git@github.com:/tedski999/dots"
git_http="https://github.com/tedski999/dots"

# Use dots as shortcut to git in home directory
[ "$1" != "init" ] && exec git --git-dir="$dots" --work-tree="$HOME" "$@"
shift

# Common variables and functions
unset recommend_restart update_initramfs
msg() { printf "\n\033[1;33m$@\033[0m\n"; }

# Parse command-line arguments
unset gui sys
while [ "$#" -gt 0 ]; do
	case "$1" in
		gui) gui=1; shift;; # Install GUI packages with Nix
		sys) sys=1; shift;; # Configure system with root privileges
		*) echo "Usage: $0 init [gui] [sys]"; exit 1;;
	esac
done

# Ensure nix is installed
[ -d /nix ] || {
	msg "=== Installing Nix ==="
	hash curl xz || exit 1
	rm -f "$HOME/.local/state/nix/profiles/profile" || exit 1
	NIX_CONFIG="use-xdg-base-directories = true" sh -c "$(curl -L https://nixos.org/nix/install)" -- --no-daemon --no-modify-profile || exit 1
}
hash nix 2>/dev/null || {
	. "$HOME/.local/state/nix/profile/etc/profile.d/nix.sh" || exit 1
	recommend_restart=1
}

# Ensure dots repo is installed
[ -d "$dots" ] || {
	msg "=== Bootstrapping dots ==="
	nixgit() { nix --experimental-features "nix-command flakes" --use-xdg-base-directories --max-jobs auto run "nixpkgs#git" -- $@; }
	nixgit clone --bare "$git_http" "$dots" || exit 1
	if ! out="$(nixgit --git-dir="$dots" --work-tree="$HOME" checkout main 2>&1)"; then
		echo "WARNING: The next operation WILL overwrite the following files:"
		printf "%s" "$out" | tail --lines +2 | head --lines -2
		printf "Enter y to proceed with data loss: " && read -r res
		[ "$res" = "y" ] && nixgit --git-dir="$dots" --work-tree="$HOME" checkout main --force || exit 1
	fi
}

# Install CLI or GUI packages or upgrade everything
# TODO: does override-input change the lockfile? otherwise upgrade is going to be missing gui packages
nix profile list --json | grep --quiet --fixed-strings ".config/nix" && {
	msg "=== Upgrading packages ==="
	nix profile upgrade --impure ".*" || exit 1
} || {
	msg "=== Installing packages ==="
	[ -n "$gui" ] && enable_gui="github:boolean-option/true" || enable_gui="github:boolean-option/false"
	nix profile install --impure --override-input enable_gui "$enable_gui" path:"$HOME/.config/nix" || exit 1
}

# Configure home stuff with expected state
[ -n "$HOME" ] && {
	msg "=== Configuring home ==="

	msg "Setting up required directory structure..."
	mkdir -p "$HOME/.local/share/fonts" "$dots/info" || exit 1
	ln -snf "$HOME/.local/state/nix/profile/share/fonts" "$HOME/.local/share/fonts/nix" || exit 1
	chmod 644 "$HOME/.ssh/config" || exit 1

	msg "Writing .gitignore to dots exclude file..."
	>"$dots/info/exclude" echo "/*
!/.config
!/.gnupg
!/.local
!/.ssh
!/.zshenv
!/.zshrc

/.config/*
!/.config/alacritty
!/.config/bat
!/.config/docker
!/.config/dunst
!/.config/git
!/.config/hypr
!/.config/less
!/.config/mpv
!/.config/neofetch
!/.config/nix
!/.config/npm
!/.config/nvim
!/.config/python
!/.config/ripgrep
!/.config/tmux
!/.config/mimeapps.list
!/.config/user-dirs.dirs
!/.config/user-dirs.locale

/.gnupg/*
!/.gnupg/gpg-agent.conf
!/.gnupg/sshcontrol

/.local/*
!/.local/bin
/.local/bin/*
!/.local/bin/dots

/.ssh/*
!/.ssh/config" || exit 1

	[ "$(dots remote get-url origin)" = "$git_http" ] && {
		msg "Upgrading dots to authenticated repo..."
		ssh-add -L && {
			dots remote set-url origin "$git_ssh" \
				&& dots fetch || exit 1
		}
	}
}

# Configure root stuff if we're taking over this system completely
[ -n "$sys" ] && {
	msg "=== Configuring system ==="

	[ "$SHELL" != "$HOME/.local/state/nix/profile/bin/zsh" ] && {
		msg "Setting user shell to Nix-managed zsh..."
		sudo chsh -s "$HOME/.local/state/nix/profile/bin/zsh" "$USER" || exit 1
		recommend_restart=1
	}

	[ -f /etc/login.defs ] && {
		msg "Hushing logins..."
		sudo sed -i 's/^HUSHLOGIN_FILE.*/HUSHLOGIN_FILE\t./' /etc/login.defs || exit 1
	}

	[ -d /etc/sudoers.d ] && {
		msg "Disabling .sudo_as_admin_successful file..."
		echo "Defaults !admin_flag" | sudo tee /etc/sudoers.d/disable_admin_file \
			&& rm -f "$HOME/.sudo_as_admin_successful" || exit 1
	}

	[ -d /etc/systemd ] && {
		msg "Enabling autologin on tty1..."
		sudo mkdir -p /etc/systemd/system/getty@tty1.service.d \
			&& printf "[Service]\nType=simple\nExecStart=\nExecStart=-/sbin/agetty --autologin "$USER" --noclear %%I 38400 linux\n" \
			| sudo tee /etc/systemd/system/getty@tty1.service.d/autologin.conf || exit 1
		systemctl is-active --quiet systemd-logind || {
			msg "Starting logind service..."
			sudo systemctl start systemd-logind || exit 1
		}
	}

	[ -f /etc/default/grub ] && {
		msg "Setting grub config..."
		printf 'GRUB_DEFAULT=0\nGRUB_TIMEOUT_STYLE=hidden\nGRUB_TIMEOUT=0\nGRUB_CMDLINE_LINUX_DEFAULT="quiet splash"\nGRUB_CMDLINE_LINUX=""\n' \
			| sudo tee /etc/default/grub && sudo update-grub || exit 1
		update_initramfs=1
	}

	[ -f /lib/cryptsetup/functions ] && {
		msg "Setting crypt prompt..."
		sudo sed -i 's/Please unlock disk $CRYPTTAB_NAME: /Email: ski@h8c.de\nPassword: /' /lib/cryptsetup/functions || exit 1
		update_initramfs=1
	}

	[ -n "$update_initramfs" ] && {
		msg "Updating initramfs..."
		sudo update-initramfs -u || exit 1
	}
}

msg "=== Initialisation and configuration complete ==="
[ -n "$recommend_restart" ] && echo "You need to restart your shell for full changes to take effect"
[ -n "$update_initramfs" ] && echo "Note that initramfs has been updated so you should try rebooting"
