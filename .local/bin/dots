#!/bin/sh

# apt update; apt install --yes curl; curl https://h8c.de/dots | sh -s init msung apts opts

root="$HOME/.local/dots"
sc='\033[0;32m'
rc='\033[0m'

[ "$1" != "init" ] && exec git --git-dir="$root" --work-tree="$HOME" "$@"

##########
# Common #
##########

gitignore() {
	mkdir -p "$root/info"
	>"$root/info/exclude" echo "\
/*
!/.config
!/.gnupg
!/.local
!/.ssh
!/.zshenv
!/.zshrc

/.config/*
!/.config/alacritty
!/.config/bat
!/.config/git
!/.config/npm
!/.config/nvim
!/.config/tmux
!/.config/wget
!/.config/mimeapps.list
!/.config/user-dirs.dirs
!/.config/user-dirs.locale
!/.config/ripgrep

/.gnupg/*
!/.gnupg/gpg-agent.conf
!/.gnupg/sshcontrol

/.local/*
!/.local/bin
/.local/bin/*
!/.local/bin/cachecmd
!/.local/bin/dots
!/.local/bin/git

/.ssh/*
!/.ssh/config"
}

#########
# Msung #
#########

msung_apts() {
	echo "${sc}Installing msung system packages...${rc}"

	hash apt-get || { echo "Cannot install system packages: apt-get not found"; exit 1; }

	$sudo curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
	echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg arch=amd64] https://brave-browser-apt-release.s3.brave.com/ stable main" | $sudo tee /etc/apt/sources.list.d/brave-browser-release.list
	$sudo apt-get update --yes
	$sudo apt-get upgrade --yes
	$sudo apt-get install --yes \
		exa btop ripgrep ranger npm python3 \
		zsh zsh-syntax-highlighting \
		# alacritty fonts-terminus brave-browser \
		# software-properties-common

	echo "${sc}Finished installing msung system packages.${rc}"
}

msung_opts() {
	echo "${sc}Installing msung opts packages...${rc}"

	# TODO: share shares

	tmp="$(mktemp --directory)"
	bin="$HOME/.local/bin"
	opt="$HOME/.local/opt"
	cmp="$ZSH_DATA/completions"
	mkdir -p "$bin" "$opt" "$cmp"

	# nvim
	rm -rf "$opt/nvim" && mkdir -p "$opt/nvim"
	curl -L https://github.com/neovim/neovim/releases/download/v0.9.0/nvim.appimage -o "$tmp/nvim.appimage"
	chmod +x "$tmp/nvim.appimage"
	cd "$opt/nvim" && "$tmp/nvim.appimage" --appimage-extract; cd -
	ln -sf "$opt/nvim/squashfs-root/AppRun" "$bin/nvim"
	ln -sf "$bin/nvim" "$bin/vim"

	# TODO: neovim/pynvim

	# zsh-syntax-highlighting
	rm -rf "$opt/zsh-syntax-highlighting" && mkdir -p "$opt/zsh-syntax-highlighting"
	curl -L https://github.com/zsh-users/zsh-syntax-highlighting/archive/refs/heads/master.zip -o "$tmp/zsh-syntax-highlighting.zip"
	unzip "$tmp/zsh-syntax-highlighting.zip" -d "$opt/zsh-syntax-highlighting"

	# zsh-completions
	rm -rf "$opt/zsh-completions" && mkdir -p "$opt/zsh-completions"
	curl -L https://github.com/zsh-users/zsh-completions/archive/refs/tags/0.34.0.tar.gz | tar -xzf - -C "$opt/zsh-completions"
	ln -sf "$opt/zsh-completions" "$cmp/"

	# TODO: arzsh-complete

	# fzf
	rm -rf "$opt/fzf" && mkdir -p "$opt/fzf"
	curl -L https://github.com/junegunn/fzf/releases/download/0.40.0/fzf-0.40.0-linux_amd64.tar.gz | tar -xzf - -C "$opt/fzf"
	curl -L https://raw.githubusercontent.com/junegunn/fzf/master/shell/completion.zsh -o "$opt/fzf/completion.zsh"
	curl -L https://raw.githubusercontent.com/junegunn/fzf/master/shell/key-bindings.zsh -o "$opt/fzf/key-bindings.zsh"
	ln -sf "$opt/fzf/fzf" "$bin/fzf"

	# zoxide
	rm -rf "$opt/zoxide" && mkdir -p "$opt/zoxide"
	curl -L https://github.com/ajeetdsouza/zoxide/releases/download/v0.9.1/zoxide-0.9.1-x86_64-unknown-linux-musl.tar.gz | tar -xzf - -C "$opt/zoxide"
	ln -sf "$opt/zoxide/zoxide" "$bin/zoxide"

	# bat
	rm -rf "$opt/bat" && mkdir -p "$opt/bat"
	curl -L https://github.com/sharkdp/bat/releases/download/v0.23.0/bat-v0.23.0-x86_64-unknown-linux-musl.tar.gz | tar -xzf - -C "$opt/bat"
	ln -sf "$opt/bat/bat-v0.23.0-x86_64-unknown-linux-musl/bat" "$bin/bat"

	# fd
	rm -rf "$opt/fd" && mkdir -p "$opt/fd"
	curl -L https://github.com/sharkdp/fd/releases/download/v8.7.0/fd-v8.7.0-x86_64-unknown-linux-musl.tar.gz | tar -xzf - -C "$opt/fd"
	ln -sf "$opt/fd/fd-v8.7.0-x86_64-unknown-linux-musl/fd" "$bin/fd"

	# TODO: mosh
	# download 1.4.0 source
	# patch with #1167 Improve cursor style handling
	# build and install

	# rust
	rm -rf "$XDG_DATA_HOME/cargo" "$XDG_DATA_HOME/rustup"
	curl https://sh.rustup.rs -sSf | sh -s -- --component rust-analyzer --component rust-src --no-modify-path -y
	. "$XDG_DATA_HOME/cargo/env"
	ln -sf "$RUSTUP_HOME/toolchains/stable-x86_64-unknown-linux-gnu/share/zsh/site-functions/*" "$cmp/"
	rustup completions zsh > "$cmp/_rustup"

	echo "${sc}Finished installing msung opts packages.${rc}"
}

# TODO: better notifications and clipboard exts
msung_exts() {
	echo "${sc}Installing msung Gnome extensions...${rc}"

	hash git make tsc || {
		hash apt-get || { echo "Cannot install extensions: git make tsc not found"; exit 1; }
		$sudo apt-get install --yes git make node-typescript
	}

	tmp="$(mktemp --directory)"
	ext="$XDG_DATA_HOME/gnome-shell/extensions"
	mkdir -p "$ext"

	# pop-shell@system76.com
	git clone https://github.com/pop-os/shell "$tmp/pop"
	make --directory "$tmp/pop" depcheck compile install

	# unite@hardpixel.eu
	rm -rf "$ext/unite@hardpixel.eu"
	git clone https://github.com/hardpixel/unite-shell "$tmp/unite"
	mv "$tmp/unite/unite@hardpixel.eu" "$ext/unite@hardpixel.eu"

	# clipboard-indicator@tudmotu.com
	rm -rf "$ext/clipboard-indicator@tudmotu.com"
	git clone https://github.com/Tudmotu/gnome-shell-extension-clipboard-indicator "$ext/clipboard-indicator@tudmotu.com"

	# expandable-notifications@kaan.g.inam.org
	rm -rf "$ext/expandable-notifications@kaan.g.inam.org"
	git clone https://github.com/kaanginam/expandable-notifications "$tmp/notifs"
	mv "$tmp/notifs/expandable-notifications@kaan.g.inam.org" "$ext/expandable-notifications@kaan.g.inam.org"

	# no-overview@fthx
	rm -rf "$ext/no-overview@fthx"
	git clone https://github.com/fthx/no-overview.git "$ext/no-overview@fthx"

	# draw-on-your-screen2@zhrexl.github.com
	rm -rf "$ext/draw-on-your-screen2@zhrexl.github.com"
	git clone https://github.com/zhrexl/DrawOnYourScreen2.git "$ext/draw-on-your-screen2@zhrexl.github.com"
	git --git-dir "$ext/draw-on-your-screen2@zhrexl.github.com/.git" --work-tree "$ext/draw-on-your-screen2@zhrexl.github.com" reset --hard 2615c7a

	# notification-timeout@chlumskyvaclav.gmail.com
	rm -rf "$ext/notification-timeout@chlumskyvaclav.gmail.com"
	git clone https://github.com/vchlum/notification-timeout.git "$ext/notification-timeout@chlumskyvaclav.gmail.com"

	echo "${sc}Finished installing msung Gnome extensions.${rc}"
}

msung_config() {
	echo "${sc}Configuring msung...${rc}"

	gitignore

	$sudo chsh $USER -s "$(which zsh)"

	echo "\
[org/gnome/desktop/a11y/applications]
screen-magnifier-enabled=false

[org/gnome/desktop/a11y/magnifier]
cross-hairs-clip=false
invert-lightness=false
lens-mode=true
mag-factor=1.0
mouse-tracking='proportional'
scroll-at-edges=true
show-cross-hairs=false

[org/gnome/desktop/background]
color-shading-type='solid'
picture-uri='none'
picture-uri-dark='none'
primary-color='#1c1c1c'
secondary-color='#000000000000'

[org/gnome/desktop/input-sources]
per-window=false
sources=[('xkb', 'gb')]
xkb-options=['caps:escape']

[org/gnome/desktop/interface]
clock-show-date=false
clock-show-weekday=true
color-scheme='prefer-dark'
font-hinting='slight'
gtk-theme='Yaru-blue-dark'
icon-theme='Yaru-blue'

[org/gnome/desktop/lockdown]
disable-log-out=false
disable-user-switching=true

[org/gnome/desktop/peripherals/keyboard]
delay=uint32 250

[org/gnome/desktop/peripherals/touchpad]
two-finger-scrolling-enabled=true

[org/gnome/desktop/screensaver]
color-shading-type='solid'
picture-uri='none'
primary-color='#1c1c1c'
secondary-color='#000000000000'

[org/gnome/desktop/session]
idle-delay=uint32 600

[org/gnome/desktop/wm/keybindings]
activate-window-menu=@as []
begin-move=@as []
begin-resize=@as []
close=['<Super>q']
cycle-group=@as []
cycle-group-backward=@as []
cycle-panels=@as []
cycle-panels-backward=@as []
cycle-windows=@as []
cycle-windows-backward=@as []
maximize=@as []
minimize=@as []
move-to-monitor-down=@as []
move-to-monitor-left=@as []
move-to-monitor-right=@as []
move-to-monitor-up=@as []
move-to-workspace-1=['<Shift><Super>1']
move-to-workspace-10=['<Shift><Super>0']
move-to-workspace-11=@as []
move-to-workspace-12=@as []
move-to-workspace-2=['<Shift><Super>2']
move-to-workspace-3=['<Shift><Super>3']
move-to-workspace-4=['<Shift><Super>4']
move-to-workspace-5=['<Shift><Super>5']
move-to-workspace-6=['<Shift><Super>6']
move-to-workspace-7=['<Shift><Super>7']
move-to-workspace-8=['<Shift><Super>8']
move-to-workspace-9=['<Shift><Super>9']
move-to-workspace-last=@as []
move-to-workspace-left=['<Primary><Shift><Super>h']
move-to-workspace-right=['<Primary><Shift><Super>l']
panel-run-dialog=@as []
show-desktop=@as []
switch-applications=@as []
switch-applications-backward=@as []
switch-group=@as []
switch-group-backward=@as []
switch-input-source=@as []
switch-input-source-backward=@as []
switch-panels=@as []
switch-panels-backward=@as []
switch-to-workspace-1=['<Super>1']
switch-to-workspace-10=['<Super>0']
switch-to-workspace-11=@as []
switch-to-workspace-12=@as []
switch-to-workspace-2=['<Super>2']
switch-to-workspace-3=['<Super>3']
switch-to-workspace-4=['<Super>4']
switch-to-workspace-5=['<Super>5']
switch-to-workspace-6=['<Super>6']
switch-to-workspace-7=['<Super>7']
switch-to-workspace-8=['<Super>8']
switch-to-workspace-9=['<Super>9']
switch-to-workspace-last=@as []
switch-to-workspace-left=['<Primary><Super>h']
switch-to-workspace-right=['<Primary><Super>l']
switch-windows=['<Super>Tab']
switch-windows-backward=['<Shift><Super>Tab']
toggle-fullscreen=['<Super>m']
toggle-maximized=@as []
unmaximize=@as []

[org/gnome/desktop/wm/preferences]
action-middle-click-titlebar='none'
action-right-click-titlebar='none'
button-layout=':maximize,close'
resize-with-right-button=true

[org/gnome/mutter]
attach-modal-dialogs=false
center-new-windows=false
overlay-key='Super_R'
workspaces-only-on-primary=false

[org/gnome/mutter/keybindings]
toggle-tiled-left=@as []
toggle-tiled-right=@as []
switch-monitor=@as []

[org/gnome/settings-daemon/plugins/media-keys]
area-screenshot=['Print']
area-screenshot-clip=@as []
custom-keybindings=['/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/', '/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom1/', '/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom2/', '/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom3/']
help=@as []
home=@as []
logout=['<Primary><Super>Escape']
magnifier=['<Shift><Super>plus']
magnifier-zoom-in=['<Super>equal']
magnifier-zoom-out=['<Super>minus']
rotate-video-lock-static=@as []
screencast=['<Shift>Print']
screenreader=@as []
screensaver=['<Super>Escape']
screenshot=@as []
screenshot-clip=@as []
terminal=['<Super>Return']
window-screenshot=@as []
window-screenshot-clip=@as []
www=['<Super>w']

[org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0]
binding='<Shift><Super>Escape'
command='systemctl suspend'
name='Suspend'

[org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom1]
binding='<Super>d'
command='discord'
name='Discord'

[org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom2]
binding='<Super>s'
command='steam'
name='Steam'

[org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom3]
binding='<Primary><Shift><Super>Escape'
command='gnome-session-quit --power-off'
name='Power Off'

[org/gnome/settings-daemon/plugins/power]
power-button-action='suspend'
sleep-inactive-ac-timeout=1800
sleep-inactive-ac-type='suspend'
sleep-inactive-battery-timeout=1800

[org/gnome/shell]
app-picker-view=uint32 1
disable-user-extensions=false
disabled-extensions=['ubuntu-dock@ubuntu.com', 'ubuntu-appindicators@ubuntu.com', 'ding@rastersoft.com']
enabled-extensions=['pop-shell@system76.com', 'clipboard-indicator@tudmotu.com', 'unite@hardpixel.eu', 'no-overview@fthx', 'draw-on-your-screen2@zhrexl.github.com', 'expandable-notifications@kaan.g.inam.org', 'notification-timeout@chlumskyvaclav.gmail.com']
favorite-apps=@as []
had-bluetooth-devices-setup=true
welcome-dialog-last-shown-version='42.5'

[org/gnome/shell/app-switcher]
current-workspace-only=false

[org/gnome/shell/extensions/clipboard-indicator]
cache-size=2048
clear-history=@as []
disable-down-arrow=true
display-mode=0
history-size=200
move-item-first=true
next-entry=['<Shift><Super>v']
notify-on-copy=false
prev-entry=['<Primary><Super>v']
preview-size=50
strip-text=false
toggle-menu=['<Super>v']

[org/gnome/shell/extensions/draw-on-your-screen]
drawing-on-desktop=false
erase-drawings=['<Control><Super>p']
indicator-disabled=false
osd-disabled=false
toggle-drawing=['<Super>p']
toggle-modal=['<Shift><Super>p']

[org/gnome/shell/extensions/notification-timeout]
ignore-idle=false
timeout=1800000

[org/gnome/shell/extensions/pop-shell]
activate-launcher=@as []
active-hint-border-radius=uint32 1
active-hint=true
focus-down=['<Super>j']
focus-left=['<Super>h']
focus-right=['<Super>l']
focus-up=['<Super>k']
gap-inner=uint32 1
gap-outer=uint32 1
hint-color-rgba='rgba(255,255,255,0.25)'
management-orientation=@as []
mouse-cursor-follows-active-window=false
pop-monitor-down=@as []
pop-monitor-left=@as []
pop-monitor-right=@as []
pop-monitor-up=@as []
pop-workspace-down=@as []
pop-workspace-left=@as []
pop-workspace-right=@as []
pop-workspace-up=@as []
show-skip-taskbar=false
show-title=false
smart-gaps=false
snap-to-grid=false
stacking-with-mouse=false
tile-accept=['r', 'Return', 'Escape']
tile-by-default=true
tile-enter=['<Super>r']
tile-move-down=@as []
tile-move-down-global=['<Shift><Super>j']
tile-move-left=@as []
tile-move-left-global=['<Shift><Super>h']
tile-move-right=@as []
tile-move-right-global=['<Shift><Super>l']
tile-move-up=@as []
tile-move-up-global=['<Shift><Super>k']
tile-reject=@as []
tile-resize-down=['j']
tile-resize-left=['h']
tile-resize-right=['l']
tile-resize-up=['k']
tile-swap-down=@as []
tile-swap-left=@as []
tile-swap-right=@as []
tile-swap-up=@as []
toggle-floating=['<Super>f']
toggle-stacking-global=@as []

[org/gnome/shell/extensions/unite]
app-menu-ellipsize-mode='end'
app-menu-max-width=0
desktop-name-text=''
extend-left-box=true
greyscale-tray-icons=false
hide-activities-button='always'
hide-app-menu-icon=false
hide-dropdown-arrows=true
hide-window-titlebars='always'
reduce-panel-spacing=true
show-desktop-name=true
show-legacy-tray=true
show-window-buttons='never'
show-window-title='always'
window-buttons-placement='auto'

[org/gnome/shell/keybindings]
focus-active-notification=['<Super>n']
open-application-menu=@as []
screenshot=@as []
screenshot-window=@as []
show-screen-recording-ui=@as []
switch-to-application-1=@as []
switch-to-application-2=@as []
switch-to-application-3=@as []
switch-to-application-4=@as []
switch-to-application-5=@as []
switch-to-application-6=@as []
switch-to-application-7=@as []
switch-to-application-8=@as []
switch-to-application-9=@as []
toggle-application-view=@as []
toggle-message-tray=['<Shift><Super>n']
toggle-overview=['<Super>space']" | dconf load /

	echo "${sc}Finished configuring msung.${rc}"
}

msung_all() {
	echo "${sc}Installing everything for msung...${rc}"
	msung_apts
	msung_opts
	msung_exts
	msung_config
	echo "${sc}Finished installing everything for msung.${rc}"
}

###########
# Msungie #
###########

# TODO: msungie init

#########
# Septs #
#########

# TODO: septs init

###############
# Driver code #
###############

set -e

hash sudo 2>/dev/null && sudo="sudo" || sudo=""
[ -z "$SUDO_USER" ] || { echo "Run without sudo privileges."; exit 1; }

shift
device="$1"
case "$device" in
	"msung"|"septs"|"msungie") ;;
	"") echo "Usage: dots init <device> [targets...]"; exit 1 ;;
	*) echo "Unknown device: $device"; exit 1 ;;
esac

shift
funcs=""
for target in "$@"; do
	func="${device}_${target}"
	type "$func" >/dev/null || { echo "Unknown target for $device: $target"; exit 1; }
	funcs="$funcs$func "
done

[ -e "$root" ] || {
	echo "${sc}$root missing, bootstrapping into $HOME...${rc}"

	hash git || {
		hash apt-get || { echo "Cannot clone dots: git not found"; exit 1; }
		$sudo apt-get install --yes git
	}

	mkdir -p "$HOME/.ssh"
	ssh-keyscan github.com >> "$HOME/.ssh/known_hosts"
	git clone --bare git@github.com:/tedski999/dots "$root" || git clone --bare https://github.com/tedski999/dots "$root"
	gitignore

	if ! out=$(git --git-dir="$root" --work-tree="$HOME" checkout main 2>&1); then
		echo "WARNING: The next operation WILL overwrite the following files:"
		printf "%s" "$out" | tail --lines +2 | head --lines -2
		printf "Enter YES to proceed with data loss: " && read -r res
		[ "$res" = "YES" ] || [ "$res" = "yes" ] || { echo "Aborted."; exit; }
		git --git-dir="$root" --work-tree="$HOME" checkout main --force
	fi

	echo "${sc}Dots successfully installed into $HOME${rc}"
}

[ -f "$HOME/.zshenv" ] || { echo "Missing .zshenv: Have dots been installed?"; exit 1; }
. "$HOME/.zshenv"

for func in $funcs; do
	"$func"
done

echo "Dots init done."
