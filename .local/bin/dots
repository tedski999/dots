#!/bin/sh

dots="$HOME/.local/dots"
[ "$1" != "init" ] && exec git --git-dir="$dots" --work-tree="$HOME" "$@"

git_ssh="git@github.com:/tedski999/dots"
git_http="https://github.com/tedski999/dots"

# TODO: opt completions and manpages
bindir="$HOME/.local/bin"
optdir="$HOME/.local/opt"
cmpdir=""
mandir=""

msung_apts="\
file curl wget tar gzip zip unzip git gnupg man-db
zsh zsh-syntax-highlighting zsh-autosuggestions
neovim git ripgrep fzf bat fd-find exa btop jq bc trash-cli
python3 python3-venv pipx
sway xwayland swayidle swaylock
nvidia-driver nvidia-driver-libs:i386 linux-headers-amd64 linux-image-amd64 firmware-misc-nonfree
mesa-vulkan-drivers libglx-mesa0:i386 mesa-vulkan-drivers:i386 libgl1-mesa-dri:i386
pipewire-audio xdg-desktop-portal-wlr playerctl
network-manager network-manager-openvpn openvpn
bluetooth bluez-firmware
wl-clipboard wlr-randr light thermald acpi
libnotify-bin mako-notifier wofi flameshot
alacritty firefox-esr obs-studio steam-installer gamemode
materia-gtk-theme paper-icon-theme
fonts-terminus fonts-noto"
msung_debs="\
git-delta https://github.com/dandavison/delta/releases/download/0.16.5/git-delta_0.16.5_amd64.deb
discord https://discord.com/api/download?platform=linux&format=deb
google-earth-pro-stable https://dl.google.com/dl/earth/client/current/google-earth-pro-stable_current_amd64.deb"
msung_opts="\
cht.sh opt_chtsh
cliphist opt_msung_cliphist"

septs_apts="\
file curl wget tar gzip zip unzip git gnupg man-db
zsh zsh-syntax-highlighting zsh-autosuggestions
neovim git ripgrep fzf bat fd-find exa btop jq bc trash-cli
python3 python3-venv pipx"
septs_debs="\
git-delta https://github.com/dandavison/delta/releases/download/0.16.5/git-delta_0.16.5_arm64.deb"
septs_opts="\
cht.sh opt_chtsh"

guest_opts="\
cht.sh opt_chtsh
zsh opt_guest_zsh
zsh-syntax-highlighting opt_guest_zshsyntaxhighlighting
zsh-autosuggestions opt_guest_zshautosuggestions
fzf opt_guest_fzf
rg opt_guest_rg
fd opt_guest_fd
bat opt_guest_bat
exa opt_guest_exa
delta opt_guest_delta"

opt_chtsh() {
	curl "https://cht.sh/:cht.sh" > "$1/cht.sh" &&
		chmod +x "$1/cht.sh" &&
		ln -sf "$1/cht.sh" "$bindir/cht.sh"
}

opt_msung_cliphist() {
	curl -L "https://github.com/sentriz/cliphist/releases/download/v0.4.0/v0.4.0-linux-amd64" > "$1/cliphist" &&
		chmod +x "$1/cliphist" &&
		ln -sf "$1/cliphist" "$bindir/cliphist"
}
opt_guest_zsh() {
	: # TODO: opt zsh
	#sh -c "$(curl -L "https://raw.githubusercontent.com/romkatv/zsh-bin/master/install)" --  -d "$1" -e no &&
#                ln -sf "$out/bin/zsh" "$bin/zsh" &&
#                ln -sf "$out/share/man/man1/"* "$man/man1/"
}
opt_guest_zshsyntaxhighlighting() {
	curl -L "https://github.com/zsh-users/zsh-syntax-highlighting/archive/refs/heads/master.tar.gz" | tar -xzC "$1"
}
opt_guest_zshautosuggestions() {
	curl -L "https://github.com/zsh-users/zsh-autosuggestions/archive/refs/heads/master.tar.gz" | tar -xzC "$1"
}
opt_guest_fzf() {
	mkdir -p "$1/x86_64" "$1/arm" &&
		curl -L "https://github.com/junegunn/fzf/releases/download/0.42.0/fzf-0.42.0-linux_amd64.tar.gz" | tar -xzC "$1/x86_64" &&
		curl -L "https://github.com/junegunn/fzf/releases/download/0.42.0/fzf-0.42.0-linux_arm64.tar.gz" | tar -xzC "$1/arm" &&
		curl -L "https://raw.githubusercontent.com/junegunn/fzf/master/shell/completion.zsh" > "$1/completion.zsh" &&
		curl -L "https://raw.githubusercontent.com/junegunn/fzf/master/shell/key-bindings.zsh" > "$1/key-bindings.zsh"
}
opt_guest_rg() {
	mkdir -p "$1/x86_64" "$1/arm" &&
		curl -L "https://github.com/BurntSushi/ripgrep/releases/download/13.0.0/ripgrep-13.0.0-x86_64-unknown-linux-musl.tar.gz" | tar -xzC "$1/x86_64" &&
		curl -L "https://github.com/BurntSushi/ripgrep/releases/download/13.0.0/ripgrep-13.0.0-arm-unknown-linux-gnueabihf.tar.gz" | tar -xzC "$1/arm"
}
opt_guest_fd() {
	mkdir -p "$1/x86_64" "$1/arm" &&
		curl -L "https://github.com/sharkdp/fd/releases/download/v8.7.0/fd-v8.7.0-x86_64-unknown-linux-musl.tar.gz" | tar -xzC "$1/x86_64" &&
		curl -L "https://github.com/sharkdp/fd/releases/download/v8.7.0/fd-v8.7.0-aarch64-unknown-linux-gnu.tar.gz" | tar -xzC "$1/arm"
}
opt_guest_bat() {
	mkdir -p "$1/x86_64" "$1/arm" &&
		curl -L "https://github.com/sharkdp/bat/releases/download/v0.24.0/bat-v0.24.0-x86_64-unknown-linux-musl.tar.gz" | tar -xzC "$1/x86_64" &&
		curl -L "https://github.com/sharkdp/bat/releases/download/v0.24.0/bat-v0.24.0-aarch64-unknown-linux-gnu.tar.gz" | tar -xzC "$1/arm"
}
opt_guest_exa() {
	mkdir -p "$1/x86_64" "$1/arm" &&
		curl -L "https://github.com/ogham/exa/releases/download/v0.10.1/exa-linux-x86_64-musl-v0.10.1.zip" > "$1/x86_64.zip" && unzip "$1/x86_64.zip" -d "$1/x86_64" &&
		curl -L "https://github.com/ogham/exa/releases/download/v0.10.1/exa-linux-armv7-v0.10.1.zip" > "$1/x86_64.zip" && unzip "$1/x86_64.zip" -d "$1/arm"
}
opt_guest_delta() {
	mkdir -p "$1/x86_64" "$1/arm" &&
		curl -L "https://github.com/dandavison/delta/releases/download/0.16.5/delta-0.16.5-x86_64-unknown-linux-musl.tar.gz" | tar -xzC "$1/x86_64" &&
		curl -L "https://github.com/dandavison/delta/releases/download/0.16.5/delta-0.16.5-aarch64-unknown-linux-gnu.tar.gz" | tar -xzC "$1/arm"
}

msg() { printf "\n\033[1;33m$@\033[0m\n"; }

# Parse arguments
shift
case "$@" in
	"msung"|"septs"|"guest") p="$@";;
	"") p="$(hostname)"; case "$p" in "msung"|"septs");; *) p="guest";; esac;;
	*) echo "Usage: $0 init [ msung | septs | guest ]"; exit 1;;
esac
msg "Using $p profile"

# Check permissions
[ "$(id -u)" = "0" ] && { echo "Please run as non-root."; exit 1; }
case "$p" in "msung"|"septs") hash sudo apt-get || exit 1; esac

# Install dots repository
[ -d "$dots" ] || {
	msg "Cloning dots repository..."
	git clone --bare "$git_http" "$dots" || exit 1
	if ! out="$(git --git-dir="$dots" --work-tree="$HOME" checkout main 2>&1)"; then
		echo "WARNING: The next operation WILL overwrite the following files:"
		printf "%s" "$out" | tail --lines +2 | head --lines -2
		printf "Enter y to proceed with data loss: " && read -r res
		[ "$res" = "y" ] && git --git-dir="$dots" --work-tree="$HOME" checkout main --force || exit 1
	fi
	mkdir -p "$dots/info" "$HOME/.local/share" || exit 1
	ln -sf "$HOME/.local/root/gitignore" "$dots/info/exclude" || exit 1
}
[ "$(git --git-dir="$dots" --work-tree="$HOME" remote get-url origin)" != "$git_ssh" ] && {
	msg "Upgrading dots remote to authenticated SSH..."
	ssh-add -L && {
		git --git-dir="$dots" --work-tree="$HOME" remote set-url origin "$git_ssh" || exit 1
		git --git-dir="$dots" --work-tree="$HOME" fetch || exit 1
	}
}

# Repair home permissions
chmod 644 "$HOME/.ssh/config" || exit 1
find "$HOME/.gnupg/" -type f -exec chmod 600 {} \; || exit 1
find "$HOME/.gnupg/" -type d -exec chmod 700 {} \; || exit 1

# Install system configuration
unset reconfig
case "$p" in
	"msung"|"septs")
		dir="$(pwd)" && cd "$HOME/.local/root/$p" || exit 1
		for file in $(find * -type f); do
			[ -L "/$file" ] || {
				msg "Installing $HOME/.local/root/$p/$file into system..."
				sudo mkdir -p "$(dirname "/$file")" || exit 1
				sudo ln -sf "$HOME/.local/root/$p/$file" "/$file" || exit 1
				sudo chown root: "/$file"
				reconfig=1
			}
		done
		cd "$dir" || exit 1
		;;
esac

# Upgrade system packages
case "$p" in
	"msung"|"septs")
		[ -z "$(find -H /var/lib/apt/lists -maxdepth 0 -mtime -1)" ] || [ -n "$reconfig" ] && {
			msg "Updating packages..."
			sudo apt-get -y update || exit 1
			sudo apt-get -y upgrade || exit 1
		}
esac

# Select appropriate packages for profile
case "$p" in
	"msung") apts="$msung_apts"; debs="$msung_debs"; opts="$msung_opts";;
	"septs") apts="$septs_apts"; debs="$septs_debs"; opts="$septs_opts";;
	"guest") apts="";            debs="";            opts="$guest_opts";;
esac

# Install apt packages
[ -n "$apts" ] && dpkg-query --show --showformat='${Status}\n' $apts 2>&1 | grep --quiet --fixed-string --regexp "no packages found matching" --regexp "not-installed" && {
	msg "Installing apt packages..."
	sudo apt-get -y install $apts || exit 1
}

# Install deb packages
missing_debs="$(echo "$debs" | while read pkg src; do dpkg-query --show --showformat='${Status}\n' $pkg 2>&1 | grep --quiet -Fe "no packages found matching" -e "not-installed" && echo "$pkg $src"; done)"
[ -n "$missing_debs" ] && {
	msg "Installing deb packages..."
	tmp="$(mktemp --suffix=.deb)" || exit 1
	echo "$missing_debs" || while read pkg src; do
		echo "Installing $pkg..."
		curl -L "$src" > "$tmp/$pkg.deb" || exit 1
		sudo apt-get -y install "$tmp/$pkg.deb" || exit 1
	done
}

# Install opt packages
missing_opts="$(echo "$opts" | while read pkg fn; do [ -d "$optdir/$pkg" ] || echo "$pkg $fn"; done)"
[ -n "$missing_opts" ] && {
	msg "Installing opt packages..."
	echo "$missing_opts" | while read pkg fn; do
		echo "Installing $pkg..."
		dir="$optdir/$pkg"
		mkdir -p "$dir" || exit 1
		$fn "$dir" || { rm -r "$dir"; exit 1; }
	done
}

# Set login shell
case "$p" in
	"msung"|"septs")
		[ "$SHELL" != "$(which zsh)" ] && {
			msg "Setting login shell to zsh..."
			sudo chsh "$USER" -s "$(which zsh)" || exit 1
		}
		;;
esac

# Install boot configuration
case "$p" in
	"msung")
		[ -n "$reconfig" ] && {
			msg "Installing boot configuration..."
			sudo update-grub || exit 1
			sudo update-initramfs -u || exit 1
		}
		;;
esac

msg "Done."
