#!/bin/sh

# sh -c "$(curl https://h8c.de/dots)" -- init

# Where to find dots repo
root="$HOME/.local/dots"
git_ssh="git@github.com:/tedski999/dots"
git_http="https://github.com/tedski999/dots"

# Use dots as shortcut to git in home directory
[ "$1" != "init" ] && exec git --git-dir="$root" --work-tree="$HOME" "$@"

# Ensure nix is installed
hash nix 2>/dev/null && [ -e /nix ] || {
	echo; echo "Installing Nix to /nix..."
	hash curl xz || exit 1
	# TODO: test for sudo privs
	sudo install -d -m 755 -o "$(id -u)" -g "$(id -g)" /nix || exit 1
	NIX_CONFIG="use-xdg-base-directories = true" \
		sh -c "$(curl -L https://nixos.org/nix/install)" -- --no-daemon --no-modify-profile || exit 1
	echo "Nix successfully installed to /nix"
}

# Ensure dots repo is installed
[ -e "$root" ] || {
	echo; echo "Dots repo missing, bootstrapping into $root..."
	nixgit() { nix --experimental-features "nix-command flakes" --use-xdg-base-directories run "nixpkgs#git" -- $@; }
	nixgit clone --bare "$git_ssh" "$root" || nixgit clone --bare "$git_http" "$root" || exit 1
	if ! out="$(nixgit --git-dir="$root" --work-tree="$HOME" checkout main 2>&1)"; then
		echo "WARNING: The next operation WILL overwrite the following files:"
		printf "%s" "$out" | tail --lines +2 | head --lines -2
		printf "Enter y to proceed with data loss: " && read -r res
		[ "$res" = "y" ] && nixgit --git-dir="$root" --work-tree="$HOME" checkout main --force || exit 1
	fi
	echo "Dots successfully installed into $root"
}

# Fix permissions
chmod 644 "$HOME/.ssh/config"

# Write dots gitignore
mkdir -p "$root/info" &&
>"$root/info/exclude" echo "/*
!/.config
!/.gnupg
!/.local
!/.ssh

/.config/*
!/.config/alacritty
!/.config/bat
!/.config/delta
!/.config/docker
!/.config/dunst
!/.config/git
!/.config/less
!/.config/mpv
!/.config/neofetch
!/.config/nix
!/.config/npm
!/.config/nvim
!/.config/python
!/.config/ripgrep
!/.config/rofi
!/.config/sxiv
!/.config/tmux
!/.config/zsh
!/.config/mimeapps.list
!/.config/user-dirs.dirs
!/.config/user-dirs.locale

/.gnupg/*
!/.gnupg/gpg-agent.conf
!/.gnupg/sshcontrol

/.local/*
!/.local/bin
/.local/bin/*
!/.local/bin/dots
!/.local/bin/git

/.ssh/*
!/.ssh/config"

# Install packages
nix profile remove ".*"
nix profile install path:$HOME/.config/nix

# TODO: will need to set shell to nix zsh somehow
# $HOME/.local/state/nix/profile/bin/zsh

# TODO: nixify patched mosh install
# opt mosh "https://github.com/mobile-shell/mosh/archive/refs/tags/mosh-1.4.0.tar.gz"
# dl "https://github.com/mobile-shell/mosh/pull/1167.diff"
# patch -p1 -i "$dl" -d "$out/mosh-mosh-1.4.0"
# cd "$out/mosh-mosh-1.4.0" && ./autogen.sh && ./configure && make

echo; echo "Done."
